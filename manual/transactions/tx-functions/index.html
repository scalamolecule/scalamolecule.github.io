<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
    <link href='http://fonts.googleapis.com/css?family=Merriweather+Sans:400,300,300italic,400italic,700,700italic,800,800italic'
          rel='stylesheet' type='text/css'>
    <title>Tx functions</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/highlight/styles/solarized_light.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link href="/css/style.css" rel="stylesheet">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/img/apple-touch-icon-57-precomposed.png">
    <link href="" rel="alternate" type="application/rss+xml" title="Molecule"/>
</head>
<body>


<header class="bs-docs-header">
    <div class="container">
        <div class="col-md-12 column" style="padding-left:0px; padding-right:0px; margin-bottom:15px">
            <div class="col-md-10 column" style="padding-left:0px;height:50px;">

    <ul class="nav nav-pills">
        <li><a href="/" style="padding-left: 6px; padding-right: 13px; vertical-align: top; margin-top: 2px;"><img
                src="/img/logo/MoleculeLogo600.png" alt="" width="200"></a></li>
        
        
        
        <li class="dropdown ">
            <a data-toggle="dropdown" href="/compare/" target="_top"
               onclick="javascript:top.location = '\/compare\/';return true;">Compare</a>
            
            <ul class="dropdown-menu level1" role="menu" aria-labelledby="dropdownMenu">
                
                
                
                

                
                <li><a href="/compare/datomic/">Datomic</a></li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/compare/sql/">SQL</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/compare/sql/slick/">Slick</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li><a href="/compare/gremlin/">Gremlin</a></li>
                

                
                
            </ul>
            
        </li>
        
        
        <li class="dropdown ">
            <a data-toggle="dropdown" href="/resources/" target="_top"
               onclick="javascript:top.location = '\/resources\/';return true;">Resources</a>
            
            <ul class="dropdown-menu level1" role="menu" aria-labelledby="dropdownMenu">
                
                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/resources/tutorials/">Tutorials</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/resources/tutorials/seattle/">Seattle</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/resources/videos/">Videos</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/resources/videos/2017-04-25_Marc_Grue/">Molecule presentation</a></li>
                        
                    </ul>
                </li>
                

                
                
            </ul>
            
        </li>
        
        
        <li class="dropdown active">
            <a data-toggle="dropdown" href="/manual/" target="_top"
               onclick="javascript:top.location = '\/manual\/';return true;">Manual</a>
            
            <ul class="dropdown-menu level1" role="menu" aria-labelledby="dropdownMenu">
                
                

                
                <li class="dropdown-submenu">
                    <a href="/manual/">Quick start</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/manual/quick-start/introduction/">Introduction</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li><a href="/manual/setup/">Setup</a></li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/manual/schema/">Schema</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/manual/schema/transaction/">Transaction</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/manual/attributes/">Attributes</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/manual/attributes/basics/">Building molecules</a></li>
                        
                        <li><a href="/manual/attributes/modes/">Mandatory/Tacit/Optional</a></li>
                        
                        <li><a href="/manual/attributes/mapped/">Map attributes</a></li>
                        
                        <li><a href="/manual/attributes/expressions/">Expressions</a></li>
                        
                        <li><a href="/manual/attributes/aggregates/">Aggregates</a></li>
                        
                        <li><a href="/manual/attributes/parameterized/">Parameterized</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li><a href="/manual/entities/">Entities</a></li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/manual/relationships/">Relationships</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/manual/relationships/card-one/">Cardinality one</a></li>
                        
                        <li><a href="/manual/relationships/card-many/">Cardinality many</a></li>
                        
                        <li><a href="/manual/relationships/composites/">Composites</a></li>
                        
                        <li><a href="/manual/relationships/bidirectional/">Bidirectional</a></li>
                        
                        <li><a href="/manual/relationships/self-join/">Self-join</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/manual/crud/">&#34;CRUD&#34;</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/manual/crud/save/">Save</a></li>
                        
                        <li><a href="/manual/crud/insert/">Insert</a></li>
                        
                        <li><a href="/manual/crud/get/">Get</a></li>
                        
                        <li><a href="/manual/crud/getJson/">Get Json</a></li>
                        
                        <li><a href="/manual/crud/update/">Update</a></li>
                        
                        <li><a href="/manual/crud/retract/">Retract</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/manual/transactions/">Transactions</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/manual/transactions/tx-bundle/">Tx bundle</a></li>
                        
                        <li><a href="/manual/transactions/tx-functions/">Tx functions</a></li>
                        
                        <li><a href="/manual/transactions/tx-meta-data/">Tx meta data</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/manual/time/">Time</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/manual/time/asof-since/">AsOf/Since</a></li>
                        
                        <li><a href="/manual/time/history/">History</a></li>
                        
                        <li><a href="/manual/time/with/">With</a></li>
                        
                        <li><a href="/manual/time/testing/">Testing</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/manual/generic/">Generic</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/manual/generic/datom/">Datom</a></li>
                        
                        <li><a href="/manual/generic/indexes/">Index</a></li>
                        
                        <li><a href="/manual/generic/log/">Log</a></li>
                        
                        <li><a href="/manual/generic/schema/">Schema</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/manual/debug/">Debug</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/manual/debug/datalog/">Datalog/data</a></li>
                        
                        <li><a href="/manual/debug/debug-transactions/">Transactions</a></li>
                        
                        <li><a href="/manual/debug/err/">Errors</a></li>
                        
                    </ul>
                </li>
                

                
                
            </ul>
            
        </li>
        
        
        <li class="dropdown ">
            <a data-toggle="dropdown" href="/api/molecule" target="_top"
               onclick="javascript:top.location = '\/api\/molecule';return true;">Docs</a>
            
            <ul class="dropdown-menu level1" role="menu" aria-labelledby="dropdownMenu">
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/api">api</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/api/Entity.html">Entity</a></li>
                        
                        <li><a href="/api/molecule/api/EntityOps.html">EntityOps</a></li>
                        
                        <li><a href="/api/molecule/api/Molecule.html">Molecule</a></li>
                        
                        <li><a href="/api/molecule/api/OptionalMapOps.html">OptionalMapOps</a></li>
                        
                        <li><a href="/api/molecule/api/ShowDebug.html">ShowDebug</a></li>
                        
                        <li><a href="/api/molecule/api/TxMethods.html">TxMethods</a></li>
                        
                        <li><a href="/api/molecule/api/exception">exception</a></li>
                        
                        <li><a href="/api/molecule/api/get">get</a></li>
                        
                        <li><a href="/api/molecule/api/getAsync">getAsync</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/composition">composition</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/composition/Composite.html">Composite</a></li>
                        
                        <li><a href="/api/molecule/composition/CompositeInit.html">CompositeInit</a></li>
                        
                        <li><a href="/api/molecule/composition/CompositeInit_In_1.html">CompositeInit_In_1</a></li>
                        
                        <li><a href="/api/molecule/composition/CompositeInit_In_2.html">CompositeInit_In_2</a></li>
                        
                        <li><a href="/api/molecule/composition/CompositeInit_In_3.html">CompositeInit_In_3</a></li>
                        
                        <li><a href="/api/molecule/composition/Composite_In_1.html">Composite_In_1</a></li>
                        
                        <li><a href="/api/molecule/composition/Composite_In_2.html">Composite_In_2</a></li>
                        
                        <li><a href="/api/molecule/composition/Composite_In_3.html">Composite_In_3</a></li>
                        
                        <li><a href="/api/molecule/composition/Nested.html">Nested</a></li>
                        
                        <li><a href="/api/molecule/composition/Nested_In_1.html">Nested_In_1</a></li>
                        
                        <li><a href="/api/molecule/composition/Nested_In_2.html">Nested_In_2</a></li>
                        
                        <li><a href="/api/molecule/composition/Nested_In_3.html">Nested_In_3</a></li>
                        
                        <li><a href="/api/molecule/composition/Tx.html">Tx</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/exceptions">exceptions</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/exceptions/package$$MoleculeCompileException.html">MoleculeCompileException</a></li>
                        
                        <li><a href="/api/molecule/exceptions/package$$MoleculeException.html">MoleculeException</a></li>
                        
                        <li><a href="/api/molecule/exceptions/package$$QueryException.html">QueryException</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/expression">expression</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/expression/AggregateKeywords.html">AggregateKeywords</a></li>
                        
                        <li><a href="/api/molecule/expression/LogicImplicits.html">AttrExpressions</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/facade">facade</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/facade/Conn.html">Conn</a></li>
                        
                        <li><a href="/api/molecule/facade/Datomic.html">Datomic</a></li>
                        
                        <li><a href="/api/molecule/facade/TxReport.html">TxReport</a></li>
                        
                        <li><a href="/api/molecule/facade/exception">exception</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/factory">factory</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/factory/Composite_Factory2.html">Composite_Factory2</a></li>
                        
                        <li><a href="/api/molecule/factory/Composite_In_1_Factory2.html">Composite_In_1_Factory2</a></li>
                        
                        <li><a href="/api/molecule/factory/Composite_In_2_Factory2.html">Composite_In_2_Factory2</a></li>
                        
                        <li><a href="/api/molecule/factory/Composite_In_3_Factory2.html">Composite_In_3_Factory2</a></li>
                        
                        <li><a href="/api/molecule/factory/Molecule_Factory2.html">Molecule_Factory2</a></li>
                        
                        <li><a href="/api/molecule/factory/Molecule_In_1_Factory2.html">Molecule_In_1_Factory2</a></li>
                        
                        <li><a href="/api/molecule/factory/Molecule_In_2_Factory2.html">Molecule_In_2_Factory2</a></li>
                        
                        <li><a href="/api/molecule/factory/Molecule_In_3_Factory2.html">Molecule_In_3_Factory2</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/generic">generic</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/generic/datom/index.html">Datom</a></li>
                        
                        <li><a href="/api/molecule/generic/index/index.html">Index</a></li>
                        
                        <li><a href="/api/molecule/generic/Log.html">Log</a></li>
                        
                        <li><a href="/api/molecule/generic/schema/index.html">Schema</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/input">input</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/input/InputMolecule.html">InputMolecule</a></li>
                        
                        <li><a href="/api/molecule/input/InputMolecule_1.html">InputMolecule_1</a></li>
                        
                        <li><a href="/api/molecule/input/InputMolecule_2.html">InputMolecule_2</a></li>
                        
                        <li><a href="/api/molecule/input/InputMolecule_3.html">InputMolecule_3</a></li>
                        
                        <li><a href="/api/molecule/input/exception">exception</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/macros">macros</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/macros/TxFns.html">TxFns</a></li>
                        
                    </ul>
                </li>
                

                
                
                

                
                <li class="dropdown-submenu">
                    <a href="/api/molecule/schema">schema</a>
                    <ul class="dropdown-menu">
                        
                        <li><a href="/api/molecule/schema/SchemaTransaction.html">SchemaTransaction</a></li>
                        
                        <li><a href="/api/molecule/schema/definition$.html">definition</a></li>
                        
                    </ul>
                </li>
                

                
                
            </ul>
            
        </li>
        
        
        <li class="dropdown ">
            <a data-toggle="dropdown" href="/dev/" target="_top"
               onclick="javascript:top.location = '\/dev\/';return true;">Dev</a>
            
            <ul class="dropdown-menu level1" role="menu" aria-labelledby="dropdownMenu">
                
                

                
                <li><a href="/dev/">Developer</a></li>
                

                
                
                

                
                <li><a href="/dev/boilerplate/">Boilerplate</a></li>
                

                
                
                

                
                <li><a href="/dev/transformation/">Transformation</a></li>
                

                
                
            </ul>
            
        </li>
        
        
        <li class="dropdown ">
            <a data-toggle="dropdown" href="/community/" target="_top"
               onclick="javascript:top.location = '\/community\/';return true;">Community</a>
            
            <ul class="dropdown-menu level1" role="menu" aria-labelledby="dropdownMenu">
                
                
                
                

                
                <li><a href="https://gitter.im/scalamolecule/Lobby">Gitter</a></li>
                

                
                
                

                
                <li><a href="https://groups.google.com/forum/#!forum/molecule-dsl">Forum</a></li>
                

                
                
                

                
                <li><a href="https://github.com/scalamolecule/molecule">Github</a></li>
                

                
                
                

                
                <li><a href="https://github.com/scalamolecule/molecule/issues">Molecule issues</a></li>
                

                
                
                

                
                <li><a href="https://github.com/scalamolecule/molecule-web/issues">Molecule docs issues</a></li>
                

                
                
            </ul>
            
        </li>
        
        <li>
            
        </li>
    </ul>

</div>

            <div class="col-md-2 column" style="padding-top:20px;padding-right:0px;">
                <ul class="nav nav-pills" style="float:right;">
                    <li>
                        <a href="/changelog" style="margin-top:-2px;">v0.17.0</a>
                    </li>
                    <li>
                        <div style="padding-left:14px;">
                            <a href="https://github.com/scalamolecule/molecule" class="github-button"
                               data-icon="octicon">Github</a>
                        </div>
                    </li>
                </ul>
            </div>

        </div>

    </div>
</header>

<div class="wrapper">
    
     

<div class="container" style="padding-top:20px">

    <div class="col-sm-10 column" style="padding-left:8px;">
        

<h1 id="transaction-functions">Transaction functions</h1>

<p><a href="https://github.com/scalamolecule/molecule/blob/master/coretests/src/test/scala/molecule/coretests/transaction/TxFunctions.scala">Tests&hellip;</a></p>

<h2 id="atomic-processing-within-the-transaction">Atomic processing within the transaction</h2>

<p>Transaction functions</p>

<ul>
<li>run on the transactor inside of transactions</li>
<li>can atomically analyze and transform database values</li>
<li>can perform arbitrary logic</li>
<li>must have no side effect</li>
<li>must return transaction data (<code>Seq[Seq[Statement]]</code>)</li>
</ul>

<p>Since tx functions have access to the tx database value they are essential to guaranteeing atomicity in updates for instance. You can
query the current db value within the transaction logic and thus be sure certain assertions hold before doing some operation.</p>

<h2 id="using-tx-functions">Using tx functions</h2>

<p>Molecule facilitates writing tx functions by annotating one or more objects that contain tx function methods:</p>

<pre><code class="language-scala">import molecule.macros.TxFns

@TxFns
object myTxFunctions {

  def myTxFunction1(args...)(implicit conn: Conn): Seq[Seq[Statement]] = {
    ...
  }
  
  def myTxFunction2(args...)(implicit conn: Conn): Seq[Seq[Statement]] = {
    ...
  }
  etc...
}


@TxFns
object myTxFunctionsSomewhereElse {...}
etc...
</code></pre>

<p>The macro annotation <code>@TxFns</code> creates an internal &ldquo;twin&rdquo; method at compile time for each Scala tx function that you define.
The twin method basically adapts to the way Datomic expects tx functions and automatically gets saved into the Datomic
database transparently without any work on your part.</p>

<h3 id="enabling-the-macro-annotation">Enabling the macro annotation</h3>

<p>To use the <code>@TxFns</code> macro annotation, you&rsquo;ll need to include the Macro Paradise compiler plugin in your build:</p>

<pre><code class="language-scala">
libraryDependencies ++= Seq(
  ...,
  compilerPlugin(&quot;org.scalamacros&quot; % &quot;paradise&quot; % &quot;2.1.1&quot; cross CrossVersion.patch)
)
</code></pre>

<blockquote>
<p>Macro annotations have been considered experimental in Scala and for version 2.12 requires an
import of the scala paradise plugin. In version 2.13 they have been incorporated into the core
language itself and importing the paradise plugin will no longer be necessary.</p>
</blockquote>

<h3 id="tx-functions-on-the-transactor-classpath">Tx functions on the transactor classpath</h3>

<p>The tx functions also need to be visible to the transactor process meaning that the compiled tx function container
must be on the classpath of the transactor. This will depend on the Datomic setup you are using:</p>

<h4 id="local-dev-in-memory">Local dev / in-memory</h4>

<p>No need to prepare anything since transaction functions defined within the project
will be available on the classpath for the Transactor managed by the Peer.</p>

<h4 id="starter-pro-pro">Starter pro / pro</h4>

<p>Set Datomic classpath variable to where your tx functions are before starting the transactor</p>

<pre><code>&gt; cd DATOMIC_HOME
&gt; export DATOMIC_EXT_CLASSPATH=/Users/mg/molecule/molecule/coretests/target/scala-2.12/test-classes/
&gt; bin/transactor ...
</code></pre>

<h4 id="free">Free</h4>

<p>The Free version can&rsquo;t set the classpath variable so we need to provide the tx functions manually
by making a jar of our classes, move it to the transactor bin folder and start the transactor:</p>

<pre><code>&gt; cd ~/molecule/molecule/coretests/target/scala-2.12/test-classes  [path to your compiled classes] 
&gt; jar cvf scala-fns.jar .
&gt; mv ~/molecule/molecule/coretests/target/scala-2.12/test-classes/scala-fns.jar DATOMIC_HOME/bin/
&gt; bin/transactor ...
</code></pre>

<h2 id="tx-function-example">Tx function example</h2>

<p>A typical example of needing access to the tx database value before doing an operation on it could be
to transfer money from one account to another.</p>

<h3 id="enforcing-atomic-constraints">Enforcing atomic constraints</h3>

<p>We want to be sure that there is enough available funds
before we do the transfer. If we had done the lookup of the current balance outside a transaction we
could risk that the balance was updated inbetween our lookup and doing the transfer. With a tx function
we can avoid this by having access to the tx database value <em>within the transaction itself</em>. This will give us
the necessary atomicity of the whole transfer. The transfer will only happen if there are enough funds available.</p>

<p>Let&rsquo;s look at a simple tx function implementation:</p>

<pre><code class="language-scala">@TxFns
object myTxFunctions {

  // Pass in entity ids of from/to accounts and the amount to be transferred
  def transfer(from: Long, to: Long, amount: Int)(implicit conn: Conn): Seq[Seq[Statement]] = {
    // Validate sufficient funds in from-account
    val curFromBalance = Account(from).balance.get.headOption.getOrElse(0)
    if (curFromBalance &lt; amount)
      throw new TxFnException(
        s&quot;Can't transfer $amount from account $from having a balance of only $curFromBalance.&quot;)

    // Calculate new balances
    val newFromBalance = curFromBalance - amount
    val newToBalance = Account(to).balance.get.headOption.getOrElse(0) + amount

    // Update accounts
    Account(from).balance(newFromBalance).getUpdateTx ++ Account(to).balance(newToBalance).getUpdateTx
  }
}
</code></pre>

<p>The signature of a tx functions must include an implicit <code>Conn</code> parameter. This makes sure that the
macro annotation can inject a database value in the generated transparent twin function for Datomic.</p>

<p>We first check the available-funds constraint by looking up the current balance and throw an
exception if there is not enough money available. Throwing an exception inside a tx function
will cancel the whole transaction and thereby guarantee atomicity.</p>

<p>Tx functions need to return transaction statements. We use Molecule&rsquo;s tx methods on
molecules for the equivalent operations to get the necessary statements. So, to get the transaction statements
of an update we simply replace a normal <code>update</code> call too <code>getUpdateTx</code> which will give us the transaction
statements produced:</p>

<pre><code class="language-scala">// Isolated update transaction (not in tx function)
Account(from).balance(newFromBalance).update

// .. equivalent to the transaction statements returned by `getUpdateTx` 
Account(from).balance(newFromBalance).getUpdateTx
</code></pre>

<h3 id="tx-functions-have-to-be-pure">Tx functions have to be pure</h3>

<p>Tx functions can&rsquo;t modify the database within the body of the tx method. You couldn&rsquo;t for instance
do an update within the method body. Any operations on the database have to be encoded in the returned
transaction statements.</p>

<h2 id="invoking-tx-functions">Invoking tx functions</h2>

<p>We call the transaction function inside a <code>transact</code> method:</p>

<pre><code class="language-scala">transact(transfer(fromAccount, toAccount, okAmount))
</code></pre>

<p><code>transact</code> is a macro that needs the tx function invocation itself as its argument in order to be able
to analyze the tx function at compile time.</p>

<p>So our complete example could look like this:</p>

<pre><code class="language-scala">// Initial balances
Account(fromAccount).balance.get.head === 100
Account(toAccount).balance.get.head === 700

// Invoke tx function to do the transfer and pass the produced tx statements to `transact`
transact(transfer(fromAccount, toAccount, 20))

// Balances after transfer
Account(fromAccount).balance.get.head === 80
Account(toAccount).balance.get.head === 720
</code></pre>

<h3 id="error-handling-ensuring-atomicity">Error handling - ensuring atomicity</h3>

<pre><code class="language-scala">// Trying to transfer a too big amount will throw an exception 
(transact(transfer(fromAccount, toAccount, 500)) must throwA[TxFnException])
  .message === s&quot;Got the exception molecule.macros.exception.TxFnException: &quot; +
  s&quot;Can't transfer 500 from account $fromAccount having a balance of only 100.&quot;
  
// No data has been changed
Account(fromAccount).balance.get.head === 100
Account(toAccount).balance.get.head === 700
</code></pre>

<h3 id="async-invocations">Async invocations</h3>

<p>Tx functions can also be invoked asynchronously:</p>

<pre><code class="language-scala">Await.result(
  transactAsync(transfer(fromAccount, toAccount, 20)) map { txReport =&gt;
    // (for brevity we check the current balances synchronously)
    Account(fromAccount).balance.get.head === 80
    Account(toAccount).balance.get.head === 720
  },
  2.seconds
)
</code></pre>

<p>For brevity examples show synchronous invocations but could as well have used async invocations.</p>

<h2 id="composing-tx-functions">Composing tx functions</h2>

<p>A tx function can be called from another tx function. We can thus compose more complex tx functions
from &ldquo;sub tx functions&rdquo;. We could for instance de-compose our previous transfer tx function into
two sub tx functions <code>withdraw</code> and <code>deposit</code> and then call those from a <code>transferComposed</code>
tx function:</p>

<pre><code class="language-scala">// &quot;Sub&quot; tx fn - can be used on its own or in other tx functions
def withdraw(from: Long, amount: Int)(implicit conn: Conn): Seq[Seq[Statement]] = {
  val curFromBalance = Account(from).balance.get.headOption.getOrElse(0)
  if (curFromBalance &lt; amount)
    throw new TxFnException(s&quot;Can't transfer $amount from account $from having a balance of only $curFromBalance.&quot;)

  val newFromBalance = curFromBalance - amount
  Account(from).balance(newFromBalance).getUpdateTx
}


// &quot;Sub&quot; tx fn - can be used on its own or in other tx functions
def deposit(to: Long, amount: Int)(implicit conn: Conn): Seq[Seq[Statement]] = {
  val newToBalance = Account(to).balance.get.headOption.getOrElse(0) + amount
  Account(to).balance(newToBalance).getUpdateTx
}


// Compose tx function by calling other tx functions
def transferComposed(from: Long, to: Long, amount: Int)(implicit conn: Conn): Seq[Seq[Statement]] = {
  // This tx function guarantees atomicity when calling multiple sub tx functions.
  // If they were called independently outside a tx function, atomicity wouldn't be guaranteed.
  withdraw(from, amount) ++ deposit(to, amount)
}
</code></pre>

<h2 id="adding-tx-meta-data-to-tx-function-invocations">Adding tx meta data to tx function invocations</h2>

<p>Tx meta data can be added to a tx function invocation by adding one or more tx meta data molecules with
applied tx meta data to the <code>transact</code>/<code>transactAsync</code> method. Say we want to add meta information about
&ldquo;who did the transfer&rdquo; then we can add it to the transaction entity like this:</p>

<pre><code class="language-scala">// Add tx meta data that John did the transfer
transact(transfer(fromAccount, toAccount, 20), Person.name(&quot;John&quot;))

// We can then query for the transfer that John did
Account(fromAccount).balance.Tx(Person.name_(&quot;John&quot;)).get.head === 80
Account(toAccount).balance.Tx(Person.name_(&quot;John&quot;)).get.head === 720
</code></pre>

<p>Note how the tx meta data applies to both accounts since they were both modified in the same
transaction that the tx meta data was applied to.</p>

<p>We can add arbitrary and possibly unrelated tx meta data to a tx function invocation by applying
two or more tx meta data molecules:</p>

<pre><code class="language-scala">// Add tx meta data that John did the transfer and that it is a scheduled transfer
transact(
  transfer(fromAccount, toAccount, 20), 
  Person.name(&quot;John&quot;), 
  UseCase.name(&quot;Scheduled transfer&quot;))

// Query multiple Tx meta data molecules
Account(fromAccount).balance
  .Tx(Person.name_(&quot;John&quot;))
  .Tx(UseCase.name_(&quot;Scheduled transfer&quot;)).get.head === 80
Account(toAccount).balance
  .Tx(Person.name_(&quot;John&quot;))
  .Tx(UseCase.name_(&quot;Scheduled transfer&quot;)).get.head === 720
</code></pre>

<h2 id="debugging-tx-function-invocations">Debugging tx function invocations</h2>

<p>If you want to see the <code>Statement</code>s produced by a tx function you can invoke it
within <code>debugTransact</code> without affecting the live database:</p>

<pre><code class="language-scala">// Print debug info for tx function invocation
debugTransact(transfer(fromAccount, toAccount, 20))

// Prints produced tx statements to output:
/*
## 1 ## TxReport 
========================================================================
1          ArrayBuffer(
  1          List(
    1          :db/add       17592186045445       :account/balance    80        Card(1))
  2          List(
    1          :db/add       17592186045447       :account/balance    720       Card(1)))
------------------------------------------------
2          List(
  1    1     added: true ,   t: 13194139534345,   e: 13194139534345,   a: 50,   v: Thu Nov 22 16:23:09 CET 2018

  2    2     added: true ,   t: 13194139534345,   e: 17592186045445,   a: 64,   v: 80
       3     added: false,  -t: 13194139534345,  -e: 17592186045445,  -a: 64,  -v: 100

  3    4     added: true ,   t: 13194139534345,   e: 17592186045447,   a: 64,   v: 720
       5     added: false,  -t: 13194139534345,  -e: 17592186045447,  -a: 64,  -v: 700)
========================================================================
*/
</code></pre>

<p>Two groups of data are shown. The first group is an internal representation in Molecule showing the operations.
The second group shows the datoms produced in the transaction. For ease of reading, &ldquo;-&rdquo; (minus) is prepended
the prefixes (t, e, a, v) for the datoms that are retractions - where <code>added</code> is false. The abbreviations
represents the parts of the Datom:</p>

<ul>
<li><code>added</code>: operation, can be true for asserted or false for retracted</li>
<li><code>t</code>: transaction entity id</li>
<li><code>e</code>: entity</li>
<li><code>a</code>: attribute</li>
<li><code>v</code>: value<br /></li>
</ul>

<p>Updating the from-account balance from 100 to 80 for instance creates two Datoms,
one retracting the old value 100 and one asserting the new value 80.</p>

<p>(The numbers on the left are simply index numbers and not part of the transactional data)</p>

<h3 id="next">Next</h3>

<p><a href="/manual/transactions/tx-meta-data">Transaction meta data&hellip;</a></p>

    </div>

    <div class="col-sm-2 column" style="padding-left:20px;padding-top:22px;padding-right: 0px;">
        <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm ">

  <div style="position:absolute;top: 15px; left: 0px;">
    
    <a class="navigation-control up" href="/manual/transactions" style="position:absolute; top:0px; left: 56px">
      <span class="glyphicon glyphicon-chevron-up"></span>
    </a>
    
    
    <a class="navigation-control left" href="/manual/transactions/tx-bundle" style="position:absolute; top: 15px; left: 20px">
      <span class="glyphicon glyphicon-chevron-left"></span>
    </a>
    
    
    <a class="navigation-control right" href="/manual/transactions/tx-meta-data" style="position:absolute; top: 15px; left: 89px">
      <span class="glyphicon glyphicon-chevron-right"></span>
    </a>
    
    
    <a class="navigation-control right" href="/manual/time" style="position:absolute; top: 30px; left: 54px;">
      <span class="glyphicon glyphicon-chevron-down"></span>
    </a>
    
  </div>

  <ul class="bs-docs-sidenav">
    
    
    
    
    <li><a href="/manual/">Quick start</a></li>
    
    <ul class="level2">
      
      <li><a href="/manual/quick-start/introduction/">Introduction</a></li>
      
      
    </ul>
    
    
    
    
    <li><a href="/manual/setup/">Setup</a></li>
    
    
    
    
    <li><a href="/manual/schema/">Schema</a></li>
    
    <ul class="level2">
      
      <li><a href="/manual/schema/transaction/">Transaction</a></li>
      
      
    </ul>
    
    
    
    
    <li><a href="/manual/attributes/">Attributes</a></li>
    
    <ul class="level2">
      
      <li><a href="/manual/attributes/basics/">Building molecules</a></li>
      
      
      
      <li><a href="/manual/attributes/modes/">Mandatory/Tacit/Optional</a></li>
      
      
      
      <li><a href="/manual/attributes/mapped/">Map attributes</a></li>
      
      
      
      <li><a href="/manual/attributes/expressions/">Expressions</a></li>
      
      
      
      <li><a href="/manual/attributes/aggregates/">Aggregates</a></li>
      
      
      
      <li><a href="/manual/attributes/parameterized/">Parameterized</a></li>
      
      
    </ul>
    
    
    
    
    <li><a href="/manual/entities/">Entities</a></li>
    
    
    
    
    <li><a href="/manual/relationships/">Relationships</a></li>
    
    <ul class="level2">
      
      <li><a href="/manual/relationships/card-one/">Cardinality one</a></li>
      
      
      
      <li><a href="/manual/relationships/card-many/">Cardinality many</a></li>
      
      
      
      <li><a href="/manual/relationships/composites/">Composites</a></li>
      
      
      
      <li><a href="/manual/relationships/bidirectional/">Bidirectional</a></li>
      
      
      
      <li><a href="/manual/relationships/self-join/">Self-join</a></li>
      
      
    </ul>
    
    
    
    
    <li><a href="/manual/crud/">&#34;CRUD&#34;</a></li>
    
    <ul class="level2">
      
      <li><a href="/manual/crud/save/">Save</a></li>
      
      
      
      <li><a href="/manual/crud/insert/">Insert</a></li>
      
      
      
      <li><a href="/manual/crud/get/">Get</a></li>
      
      
      
      <li><a href="/manual/crud/getJson/">Get Json</a></li>
      
      
      
      <li><a href="/manual/crud/update/">Update</a></li>
      
      
      
      <li><a href="/manual/crud/retract/">Retract</a></li>
      
      
    </ul>
    
    
    
    
    <li><a href="/manual/transactions/">Transactions</a></li>
    
    <ul class="level2">
      
      <li><a href="/manual/transactions/tx-bundle/">Tx bundle</a></li>
      
      
      
      <li class="active"><b>Tx functions</b></li>
      
      
      
      <li><a href="/manual/transactions/tx-meta-data/">Tx meta data</a></li>
      
      
    </ul>
    
    
    
    
    <li><a href="/manual/time/">Time</a></li>
    
    <ul class="level2">
      
      <li><a href="/manual/time/asof-since/">AsOf/Since</a></li>
      
      
      
      <li><a href="/manual/time/history/">History</a></li>
      
      
      
      <li><a href="/manual/time/with/">With</a></li>
      
      
      
      <li><a href="/manual/time/testing/">Testing</a></li>
      
      
    </ul>
    
    
    
    
    <li><a href="/manual/generic/">Generic</a></li>
    
    <ul class="level2">
      
      <li><a href="/manual/generic/datom/">Datom</a></li>
      
      
      
      <li><a href="/manual/generic/indexes/">Index</a></li>
      
      
      
      <li><a href="/manual/generic/log/">Log</a></li>
      
      
      
      <li><a href="/manual/generic/schema/">Schema</a></li>
      
      
    </ul>
    
    
    
    
    <li><a href="/manual/debug/">Debug</a></li>
    
    <ul class="level2">
      
      <li><a href="/manual/debug/datalog/">Datalog/data</a></li>
      
      
      
      <li><a href="/manual/debug/debug-transactions/">Transactions</a></li>
      
      
      
      <li><a href="/manual/debug/err/">Errors</a></li>
      
      
    </ul>
    
    
    
    
    
  </ul>
</nav>
    </div>

</div> 

     
   
 
<div class="push"></div>
</div> 

<footer class="bs-docs-footer">

  <div class="container">
    <ul class="bs-docs-footer-links">
      <li style="vertical-align: top; margin-top: 0px;"><a href="/front/"><img src="/img/logo/MoleculeLogo200.png" alt=""></a></li>
      <li><a href="https://github.com/scalamolecule/molecule">GitHub</a></li>
      <li><a href="https://github.com/scalamolecule/molecule-web">GitHub-web</a></li>
      <li><a href="https://groups.google.com/forum/#!forum/molecule-dsl">Forum</a></li>
      <li><a href="/about/">About</a></li>
      <li><a href="/credits/">Credits</a></li>
    </ul>
    <p>Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="license">Apache License 2.0</a></p>
  </div>
</footer>


<script type="text/javascript" src="/js/jquery-1.11.2.min.js"></script>



<script type="text/javascript" src="/js/bootstrap.min.js"></script>



<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script type="text/javascript" src="/js/scripts.js"></script>




<script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2787756-3', 'auto');
  ga('send', 'pageview');
</script>
    
</body>
</html>
