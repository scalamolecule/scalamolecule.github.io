<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon"/>
    <title>Time</title>
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/css/bootstrap.min.css">
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/css/highlight/styles/solarized_light.css"/>
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/css/syntax-custom.css"/>
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/css/style.css">
    <link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic,500,600,700,700italic,800,800italic'>

    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.scalamolecule.org/img/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.scalamolecule.org/img/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.scalamolecule.org/img/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="https://www.scalamolecule.org/img/apple-touch-icon-57-precomposed.png">

    
    
</head>
<body data-spy="scroll" data-target="#sidebar" data-offset="110">
<header class="bs-docs-header">

    <nav class="navbar navbar-inverse">
        <div class="container-fluid" style="max-width:1170px;padding-top:3px">
            
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="../../" style="padding-left: 6px; padding-right: 13px;"><img src="https://www.scalamolecule.org/img/logo/MoleculeLogo150.png"></a>
            </div>

            
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    
                    
                        
                            <li class="dropdown">
                                <a href="../../intro/" target="_top">Intro</a>
                            </li>
                        
                    
                        
                            <li class="dropdown">
                                <a href="../../setup/" target="_top">Setup</a>
                            </li>
                        
                    
                        
                            <li class="active">
                                <a href="../../documentation/" target="_top">Documentation</a>
                                <div></div>
                            </li>
                        
                    
                        
                            <li class="dropdown">
                                <a href="../../dev/" target="_top">Dev</a>
                            </li>
                        
                    
                        
                            <li class="dropdown">
                                <a href="../../community/" target="_top">Community</a>
                            </li>
                        
                    
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="https://javadoc.io/doc/org.scalamolecule/molecule_2.13/latest/index.html" target="_blank" style="">ScalaDocs</a></li>
                    <li><a href="../../changelog" style="">v1.0.2</a></li>
                    <li><a href="https://github.com/scalamolecule/molecule" target="_blank">
                        <img src="https://www.scalamolecule.org/vendor/GitHub-Mark/PNG/GitHub-Mark-Light-32px.png"
                             style="margin-top:-4px;padding-left:15px;opacity:0.6;width:42px;">
                    </a></li>
                </ul>
            </div>
        </div>
    </nav>

</header>

<div class="wrapper">

<div class="container-fluid" style="max-width:1170px">

    <div class="col-sm-10 " style="padding-left:8px;">
        <h1 id="time">Time</h1>
<p>Datomic has powerful ways of accessing all the immutable data that accumulates over time in the database:</p>
<p><img src="../../img/page/time/all.png" alt=""></p>
<p>The 5 time getters offer us valuable insight into the database from various perspectives:</p>





<table class="table table-bordered">
<thead>
<tr>
<th style="text-align:left">Semantics</th>
<th style="text-align:left">method</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Current view of the database</td>
<td style="text-align:left">get</td>
</tr>
<tr>
<td style="text-align:left">How the db looked after tx2 was transacted</td>
<td style="text-align:left"><a href="../../documentation/time/#asof">getAsOf(t2)</a></td>
</tr>
<tr>
<td style="text-align:left">Db with only data since (excluding) tx2 until now</td>
<td style="text-align:left"><a href="../../documentation/time/#since">getSince(t2)</a></td>
</tr>
<tr>
<td style="text-align:left">All transactions over time</td>
<td style="text-align:left"><a href="../../documentation/time/#history">getHistory</a></td>
</tr>
<tr>
<td style="text-align:left">&ldquo;What if&rdquo;-look into the future of Now + tx4data</td>
<td style="text-align:left"><a href="../../documentation/time/#with">getWith(tx4data)</a></td>
</tr>
</tbody>
</table>

<h3 id="limit-returned-data">Limit returned data</h3>
<p>The amount of data returned can be limited by adding a max row parameter (to any of the getters above):</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">some30persons</span>               <span class="k">=</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="mi">30</span><span class="o">)</span>
<span class="k">val</span> <span class="n">some20personsAsOfNov5</span>       <span class="k">=</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">nov5date</span><span class="o">,</span> <span class="mi">20</span><span class="o">)</span> 
<span class="k">val</span> <span class="n">some10personsAddedSinceNov5</span> <span class="k">=</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">getSince</span><span class="o">(</span><span class="n">nov5date</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>

<span class="c1">// The `with` methods have the limit parameter as their first argument since 
</span><span class="c1">// the last argument is a vararg for the test data.
</span><span class="c1"></span><span class="k">val</span> <span class="n">some25personsWithNewData</span> <span class="k">=</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">getWith</span><span class="o">(</span><span class="mi">25</span><span class="o">,</span> <span class="o">&lt;</span><span class="n">txTestData</span><span class="o">&gt;)</span> 
</code></pre></div><p><code>getHistory(n: Int)</code> (with a limit) is not implemented since the whole history data set normally needs to be retrieved and sorted to give chronological meaningful information.</p>
<h2 id="point-in-time">Point in time</h2>
<p>The two methods <code>getAsOf(t)</code> and <code>getSince(t)</code> takes a <em>point in time</em> in the database. Each transaction in Datomic is an <em>entity</em> with an id like all other entities saved in the database. The transaction id, or <code>tx</code>, and its equivalent transaction value <code>t</code>, both of type <code>Long</code>, or a <code>java.util.Date</code> can be used as a <em>point in time</em> for the time getters.</p>
<p><code>t</code> is a <code>Long</code> value that Datomic creates along the transaction id. It&rsquo;s not necessarily continuous like a traditional auto-increment id, so you can&rsquo;t expect a previous or next <code>t</code> to represent a transaction.</p>
<h3 id="getting-a-point-in-time-from-a-transaction">Getting a point in time from a transaction</h3>
<p>When we perform a transaction, a Molecule <code>TxReport</code> is returned with information about the transaction result. We can get the three <em>points in time</em> mentioned above from this:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">for</span> <span class="o">{</span>
  <span class="n">txReport</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;bob&#34;</span><span class="o">).</span><span class="n">save</span>
  <span class="n">t</span>        <span class="k">=</span> <span class="n">txReport</span><span class="o">.</span><span class="n">t</span>
  <span class="n">tx</span>       <span class="k">=</span> <span class="n">txReport</span><span class="o">.</span><span class="n">tx</span>
  <span class="n">date</span>     <span class="k">=</span> <span class="n">txReport</span><span class="o">.</span><span class="n">inst</span> <span class="c1">// `inst` for Datomics `instant` type (java.util.Date)
</span><span class="c1"></span><span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
</code></pre></div><h3 id="getting-a-point-in-time-with-a-molecule">Getting a point in time with a molecule</h3>
<p>Another way to get a point in time is to add one or the other generic point-in-time attribute to a molecule. We could for instance ask at what point in time, bob&rsquo;s name was asserted:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">for</span> <span class="o">{</span>
  <span class="n">t</span>      <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name_</span><span class="o">(</span><span class="s">&#34;bob&#34;</span><span class="o">).</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span><span class="o">)</span>
  <span class="n">tx</span>     <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name_</span><span class="o">(</span><span class="s">&#34;bob&#34;</span><span class="o">).</span><span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span><span class="o">)</span>
  <span class="n">txInst</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name_</span><span class="o">(</span><span class="s">&#34;bob&#34;</span><span class="o">).</span><span class="n">txInst</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
</code></pre></div><h3 id="using-a-clock-timedate">Using a clock time/date</h3>
<p>Or we can simply apply a <code>java.util.Date</code> of interest, like <code>getAsOf(nov5at1015am)</code>.</p>
<h3 id="applying-a-point-in-time">Applying a point in time</h3>
<p>As a convenience, we can also simply pass the txReport itself as a &ldquo;<em>point in time</em>&rdquo;.</p>
<p>So, here are , and we end being able to call for instance <code>getAsOf(...)</code> in 4 different ways:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">t</span><span class="o">)</span>
<span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">tx</span><span class="o">)</span>
<span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">txInst</span><span class="o">)</span> <span class="c1">// or some clock time
</span><span class="c1"></span><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">txReport</span><span class="o">)</span>
</code></pre></div><p>Whenever <code>t</code> is mentioned in the following text, you can also think of <code>tx</code>, <code>txInst</code> (<code>Date</code>) or <code>txReport</code>.</p>
<h2 id="asof">AsOf</h2>
<p><code>getAsOf(t)</code> and <code>getSince</code> are complementary functions that either get us a snapshop of the database at some point in time or a current snapshot filtered with only changes after a point in time. Like before/after scenarios.</p>
<p>Calling <code>getAsOf(t)</code> on a molecule gives us the data as of a certain point in time like <code>t2</code>:</p>
<p><img src="../../img/page/time/as-of.png" alt=""></p>
<p>Let&rsquo;s look at an example of a database that has 3 transactions:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">for</span> <span class="o">{</span>
  <span class="n">txReport1</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">).</span><span class="n">likes</span><span class="o">(</span><span class="s">&#34;pizza&#34;</span><span class="o">).</span><span class="n">save</span>
  <span class="n">johnId</span>    <span class="k">=</span> <span class="n">txReport1</span><span class="o">.</span><span class="n">eid</span> <span class="c1">// getting created entity id from tx report
</span><span class="c1"></span>  <span class="n">t1</span>        <span class="k">=</span> <span class="n">txReport1</span><span class="o">.</span><span class="n">t</span>   <span class="c1">// getting t from tx report
</span><span class="c1"></span>
  <span class="n">t2</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">likes</span><span class="o">(</span><span class="s">&#34;sushi&#34;</span><span class="o">).</span><span class="n">update</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">t</span><span class="o">)</span> 

  <span class="n">t3</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;Lisa&#34;</span><span class="o">).</span><span class="n">likes</span><span class="o">(</span><span class="s">&#34;thai&#34;</span><span class="o">).</span><span class="n">update</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">t</span><span class="o">)</span> 
<span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
</code></pre></div><p>We can then get the db value as it looked like at 3 points in time:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">t1</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">((</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;pizza&#34;</span><span class="o">)))</span>
<span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">t2</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">((</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">)))</span>
<span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">t3</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">((</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">),</span> <span class="o">(</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="s">&#34;thai&#34;</span><span class="o">)))</span>
</code></pre></div><h2 id="since">Since</h2>
<p>As a complementary function to <code>getAsOf(t)</code> we have <code>getSince(t)</code> that gives us a snapshot of the current database filtered with only changes added <em>after/since</em> <code>t</code>:</p>
<p><img src="../../img/page/time/since.png" alt=""></p>
<p>Contrary to the getAsOf(t) method, the <code>t</code> is <em>not</em> included in <code>getSince(t)</code>. Using our example we can ask of accumulated values since various points in time:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// since t1 (not included): t2 + t3 accumulated
</span><span class="c1"></span><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">t1</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">((</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">),</span> <span class="o">(</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="s">&#34;thai&#34;</span><span class="o">)))</span>

<span class="c1">// since t2 (not included): t3 
</span><span class="c1"></span><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">t2</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">((</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="s">&#34;thai&#34;</span><span class="o">)))</span>

<span class="c1">// since t3 (not included): nothing since t3
</span><span class="c1"></span><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getAsOf</span><span class="o">(</span><span class="n">t3</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">())</span>
</code></pre></div><p>As you can see, it can be valuable to ask &ldquo;What happened since t2?&rdquo; and get the answer &ldquo;&lsquo;Lisa liked thai&rsquo; was added&rdquo;.</p>
<h2 id="history">History</h2>
<p>The history perspective gives us all the assertions and retractions that has happened in the lifetime of the database(!)</p>
<p><img src="../../img/page/time/history.png" alt=""></p>
<p>Theoretically we could ask for all historical values (although Datomic doesn&rsquo;t allow a full scan of the whole database):</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// Theoretical full scan (just to show all datoms in our example)
</span><span class="c1"></span><span class="nc">Person</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">getHistory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/name&#34;</span><span class="o">,</span>  <span class="s">&#34;John&#34;</span><span class="o">,</span>  <span class="n">t1</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">t1</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
  
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
  
  <span class="n">lisa</span><span class="o">,</span> <span class="s">&#34;:Person/name&#34;</span><span class="o">,</span>  <span class="s">&#34;Lisa&#34;</span><span class="o">,</span>  <span class="n">t3</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
  <span class="n">lisa</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;thai&#34;</span><span class="o">,</span>  <span class="n">t3</span><span class="o">,</span> <span class="kc">true</span>  
<span class="o">))</span>
</code></pre></div><p>We use the generic Molecule attributes <code>e</code>, <code>a</code>, <code>v</code>, <code>t</code>/<code>tx</code>/ <code>txInst</code>, <code>op</code> to retrieve the Datom values:





<table class="table table-bordered">
<thead>
<tr>
<th style="text-align:center"><code>e</code></th>
<th style="text-align:center"><code>a</code></th>
<th style="text-align:center"><code>v</code></th>
<th style="text-align:center"><code>t</code> / <code>tx</code>/ <code>txInst</code></th>
<th style="text-align:center"><code>op</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Entity</td>
<td style="text-align:center">Attribute</td>
<td style="text-align:center">Value</td>
<td style="text-align:center">Transaction</td>
<td style="text-align:center">Operation<br>Assert (true) / Retract (false)</td>
</tr>
<tr>
<td style="text-align:center"><code>Long</code></td>
<td style="text-align:center"><code>String</code></td>
<td style="text-align:center"><code>Any</code></td>
<td style="text-align:center"><code>Long</code>/<code>Long</code>/<code>Date</code></td>
<td style="text-align:center"><code>Boolean</code></td>
</tr>
</tbody>
</table>
</p>
<h3 id="history-of-an-entity">History of an entity</h3>
<p>Now let&rsquo;s extract some useful information, like how the <code>johnId</code> entity has changed over time:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">e</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">getHistory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/name&#34;</span><span class="o">,</span>  <span class="s">&#34;John&#34;</span><span class="o">,</span>  <span class="n">t1</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">t1</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
  
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="kc">true</span>
<span class="o">))</span>
</code></pre></div><p>As you see, we have now filtered the history database to only contain datoms with entity id <code>johnId</code>. A Molecule convenience method lets us apply an entity id to the initial Namespace. We could also apply it to the generic <code>e</code> attribute and get the same result.</p>
<p>Another thing is also, that order of the returned data set is not guaranteed, so we will normally need to sort the output, in this case by transaction value, then operation to get the desired order (in the following examples we&rsquo;ll skip sorting for clarity though):</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">e</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">a</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">getHistory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">sortBy</span><span class="o">(</span><span class="n">r</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">_4</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="n">_5</span><span class="o">))</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/name&#34;</span><span class="o">,</span>  <span class="s">&#34;John&#34;</span><span class="o">,</span>  <span class="n">t1</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">t1</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
  
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;:Person/likes&#34;</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="kc">true</span>
<span class="o">))</span>
</code></pre></div><p>We can involve specific attributes like <code>Person.like</code>:</p>
<p><em>How has John&rsquo;s taste developed?:</em></p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">like_</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">getHistory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">t1</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>  <span class="c1">// pizza
</span><span class="c1"></span>  <span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="c1">// no longer pizza
</span><span class="c1"></span>  <span class="s">&#34;sushi&#34;</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="kc">true</span>   <span class="c1">// sushi
</span><span class="c1"></span><span class="o">))</span>
</code></pre></div><p>Since we declared which attribute to look for, there was no reason to return it, and we made it tacit with an underscore to <code>like_</code>.</p>
<p><em>What has John liked?:</em></p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">like_</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">op_</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="n">getHistory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="s">&#34;pizza&#34;</span><span class="o">,</span>  <span class="c1">// pizza
</span><span class="c1"></span>  <span class="s">&#34;sushi&#34;</span>   <span class="c1">// sushi
</span><span class="c1"></span><span class="o">))</span>
</code></pre></div><h3 id="history-of-an-attribute">History of an attribute</h3>
<p>We could also follow the values of an attribute for multiple entities:</p>
<p><em>Who liked what and when?</em></p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">like_</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">txInst</span><span class="o">.</span><span class="n">op_</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="n">getHistory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;pizza&#34;</span><span class="o">,</span> <span class="n">date1</span><span class="o">,</span>
  <span class="n">johnId</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">,</span> <span class="n">date2</span><span class="o">,</span>
  <span class="n">lisa</span><span class="o">,</span> <span class="s">&#34;thai&#34;</span><span class="o">,</span>  <span class="n">date3</span>  
<span class="o">))</span>
</code></pre></div><p><em>What was disliked and when?</em></p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">like_</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">txInst</span><span class="o">.</span><span class="n">op_</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="n">getHistory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="s">&#34;sushi&#34;</span><span class="o">,</span> <span class="n">date2</span>
<span class="o">))</span>
</code></pre></div><h3 id="history-with-tx-meta-data">History with Tx meta data</h3>
<p>We can even track historical <a href="../../documentation/transactions/#tx-meta-data">transaction meta data</a>, here with an example from the Provenance example in the <a href="https://github.com/scalamolecule/molecule/tree/master/moleculeTests/shared/src/test/scala/moleculeTests/tests/examples/datomic/dayOfDatomic">Day-of-Datomic test suite</a>:</p>
<p><em>Who changed the title and when?</em></p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Story</span><span class="o">.</span><span class="n">url_</span><span class="o">(</span><span class="n">ecURL</span><span class="o">).</span><span class="n">title</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">tx</span>
  <span class="o">.</span><span class="nc">Tx</span><span class="o">(</span><span class="nc">MetaData</span><span class="o">.</span><span class="n">usecase</span><span class="o">.</span><span class="nc">User</span><span class="o">.</span><span class="n">firstName</span><span class="o">).</span><span class="n">getHistory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="o">(</span><span class="s">&#34;ElastiCache in 6 minutes&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">stuTxId</span><span class="o">,</span> <span class="s">&#34;AddStories&#34;</span><span class="o">,</span> <span class="s">&#34;Stu&#34;</span><span class="o">),</span> <span class="c1">// Stu adds story
</span><span class="c1"></span>  <span class="o">(</span><span class="s">&#34;ElastiCache in 6 minutes&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">edTxId</span><span class="o">,</span> <span class="s">&#34;UpdateStory&#34;</span><span class="o">,</span> <span class="s">&#34;Ed&#34;</span><span class="o">),</span> <span class="c1">// Ed updates title
</span><span class="c1"></span>  <span class="o">(</span><span class="s">&#34;ElastiCache in 5 minutes&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">edTxId</span><span class="o">,</span> <span class="s">&#34;UpdateStory&#34;</span><span class="o">,</span> <span class="s">&#34;Ed&#34;</span><span class="o">)</span>   <span class="c1">// Ed updates title
</span><span class="c1"></span><span class="o">))</span>
</code></pre></div><p><em>&ldquo;What titles did Ed retract and in what use cases?&quot;</em></p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Story</span><span class="o">.</span><span class="n">url_</span><span class="o">(</span><span class="n">ecURL</span><span class="o">).</span><span class="n">title</span><span class="o">.</span><span class="n">op_</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
  <span class="o">.</span><span class="nc">Tx</span><span class="o">(</span><span class="nc">MetaData</span><span class="o">.</span><span class="n">usecase</span><span class="o">.</span><span class="nc">User</span><span class="o">.</span><span class="n">firstName_</span><span class="o">(</span><span class="s">&#34;Ed&#34;</span><span class="o">)).</span><span class="n">getHistory</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="o">(</span><span class="s">&#34;ElastiCache in 6 minutes&#34;</span><span class="o">,</span> <span class="s">&#34;UpdateStory&#34;</span><span class="o">)</span>
<span class="o">))</span>
</code></pre></div><p>Note the <code>Tx</code> (with capital T) that initiates adding a transaction meta data molecule. This is information that is added to the <em>transaction entity</em>, independently of the main data - like cross-cutting audit data.</p>
<p>Another example of transaction meta data could be internal company auditing data like &ldquo;use case id&rdquo;, &ldquo;who took this step in the use case&rdquo;, &ldquo;what state is the use case currently in&rdquo; etc. Being able to model and query such auditing data back in time seems like an extremely valuable feature.</p>
<h2 id="with">With</h2>
<p>We can make a <em>speculative</em> transaction with <code>getWith(txData)</code> and see how the database would look then:</p>
<p><img src="../../img/page/time/with.png" alt=""></p>
<p>The current database is filtered in-memory with the applied extra transaction data. This is a very powerful way of testing future-like &ldquo;what-if&rdquo; scenarios. We don&rsquo;t need to do any clean-up since all transaction data is automatically garbage-collected.</p>
<h4 id="with-save-tx">with save tx</h4>
<p>Continuing our example we could add another person and see how the database would then look. We can construct the transaction data to add with a call to <code>getSaveStmts</code> on a save molecule:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getWith</span><span class="o">(</span> 
  <span class="c1">// &#34;Transaction molecule&#34; with &#34;transact John&#34; tx data
</span><span class="c1"></span>  <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;Eddy&#34;</span><span class="o">).</span><span class="n">likes</span><span class="o">(</span><span class="s">&#34;cakes&#34;</span><span class="o">).</span><span class="n">getSaveStmts</span> 
<span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="s">&#34;thai&#34;</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&#34;Eddy&#34;</span><span class="o">,</span> <span class="s">&#34;cakes&#34;</span><span class="o">)</span> <span class="c1">// Eddy correctly saved
</span><span class="c1"></span><span class="o">)</span>
</code></pre></div><p>Likewise we can test the effect of other operations:</p>
<h4 id="with-insert-tx">with insert tx</h4>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getWith</span><span class="o">(</span> 
  <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getInsertStmts</span><span class="o">(</span>
    <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;burger&#34;</span><span class="o">),</span>
    <span class="o">(</span><span class="s">&#34;Sara&#34;</span><span class="o">,</span> <span class="s">&#34;french&#34;</span><span class="o">)</span>
  <span class="o">)</span> 
<span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="s">&#34;thai&#34;</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;burger&#34;</span><span class="o">),</span> <span class="c1">// John and Sara were correctly inserted
</span><span class="c1"></span>  <span class="o">(</span><span class="s">&#34;Sara&#34;</span><span class="o">,</span> <span class="s">&#34;french&#34;</span><span class="o">)</span>  
<span class="o">)</span>
</code></pre></div><h4 id="with-update-tx">with update tx</h4>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getWith</span><span class="o">(</span> 
  <span class="nc">Person</span><span class="o">(</span><span class="n">lisa</span><span class="o">).</span><span class="n">likes</span><span class="o">(</span><span class="s">&#34;lebanese&#34;</span><span class="o">).</span><span class="n">getUpdateStmts</span> 
<span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;sushi&#34;</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="s">&#34;lebanese&#34;</span><span class="o">)</span> <span class="c1">// Lisa correctly now likes lebanese food
</span><span class="c1"></span><span class="o">)</span>
</code></pre></div><h4 id="with-retract-tx">with retract tx</h4>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getWith</span><span class="o">(</span> 
  <span class="n">johnId</span><span class="o">.</span><span class="n">getRetractStmts</span> 
<span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="o">(</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="s">&#34;thai&#34;</span><span class="o">)</span>
  <span class="c1">// (John was correctly retracted) 
</span><span class="c1"></span><span class="o">)</span>
</code></pre></div><h4 id="with-multiple-operations">with multiple operations</h4>
<p>And here we transact all the above operations as one what-if scenario:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getWith</span><span class="o">(</span>
  <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;Eddy&#34;</span><span class="o">).</span><span class="n">likes</span><span class="o">(</span><span class="s">&#34;cakes&#34;</span><span class="o">).</span><span class="n">getSaveStmts</span><span class="o">,</span>
  <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">getInsertStmts</span><span class="o">(</span>
    <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;burger&#34;</span><span class="o">),</span>
    <span class="o">(</span><span class="s">&#34;Sara&#34;</span><span class="o">,</span> <span class="s">&#34;french&#34;</span><span class="o">)</span>
  <span class="o">),</span>
  <span class="nc">Person</span><span class="o">(</span><span class="n">lisa</span><span class="o">).</span><span class="n">likes</span><span class="o">(</span><span class="s">&#34;lebanese&#34;</span><span class="o">).</span><span class="n">getUpdateStmts</span><span class="o">,</span>
  <span class="n">johnId</span><span class="o">.</span><span class="n">getRetractStmts</span> 
<span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="nc">List</span><span class="o">(</span>
  <span class="o">(</span><span class="s">&#34;Eddy&#34;</span><span class="o">,</span> <span class="s">&#34;cakes&#34;</span><span class="o">),</span>   <span class="c1">// saved
</span><span class="c1"></span>  <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="s">&#34;burger&#34;</span><span class="o">),</span>  <span class="c1">// inserted
</span><span class="c1"></span>  <span class="o">(</span><span class="s">&#34;Sara&#34;</span><span class="o">,</span> <span class="s">&#34;french&#34;</span><span class="o">),</span>  <span class="c1">// inserted
</span><span class="c1"></span>  <span class="o">(</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="s">&#34;lebanese&#34;</span><span class="o">)</span> <span class="c1">// updated
</span><span class="c1"></span>                       <span class="c1">// (johnId retracted)
</span><span class="c1"></span><span class="o">)</span>
</code></pre></div><h3 id="modularizing-tx-data">Modularizing tx data</h3>
<p>Assigning transaction molecules to variables can help us modularize tests where we could for instance be interested in seeing if various orders of transactions will produce the same result:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">for</span> <span class="o">{</span>
  <span class="n">save</span>    <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">).</span><span class="n">age</span><span class="o">(</span><span class="mi">24</span><span class="o">).</span><span class="n">getSaveStmts</span>
  <span class="n">insert</span>  <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">age</span> <span class="n">getInsertStmts</span> <span class="nc">List</span><span class="o">((</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="s">&#34;Pete&#34;</span><span class="o">,</span> <span class="mi">55</span><span class="o">))</span>
  <span class="n">update</span>  <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">age</span><span class="o">(</span><span class="mi">25</span><span class="o">).</span><span class="n">getUpdateStmts</span>
  <span class="n">retract</span> <span class="k">&lt;-</span> <span class="n">someOtherPersonId</span><span class="o">.</span><span class="n">getRetractStmts</span>
  <span class="n">expectedResult</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
    <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="mi">25</span><span class="o">),</span>
    <span class="o">(</span><span class="s">&#34;Lisa&#34;</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span>
    <span class="o">(</span><span class="s">&#34;Pete&#34;</span><span class="o">,</span> <span class="mi">55</span><span class="o">)</span> 
  <span class="o">)</span>     
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">getWith</span><span class="o">(</span><span class="n">save</span><span class="o">,</span> <span class="n">insert</span><span class="o">,</span> <span class="n">update</span><span class="o">,</span> <span class="n">retract</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="n">expectedResult</span><span class="o">)</span> 
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">getWith</span><span class="o">(</span><span class="n">insert</span><span class="o">,</span> <span class="n">update</span><span class="o">,</span> <span class="n">retract</span><span class="o">,</span> <span class="n">save</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="n">expectedResult</span><span class="o">)</span>
  <span class="c1">// etc..
</span><span class="c1"></span><span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
</code></pre></div><p>There&rsquo;s no limit on the amount of transaction data applied, so more complex scenarios can be simulated too.</p>
<h2 id="test-against-testdb">Test against TestDb</h2>
<p>All molecules expect an implicit database connection object to be in scope. The connection object normal communicates with the real database, but we can ask it to communicate with an in-memory &ldquo;test database&rdquo; instead that accepts what-if transactional data as we saw above. But this time continuously for all ordinary transaction molecules.</p>
<p>It&rsquo;s a bit lit a git branch where we can always go back to the master branch / the live database.</p>
<p>When the connection/db goes out of scope it is simply garbage collected automatically by the JVM. At any point we can also explicitly go back to continuing using our live db.</p>
<h3 id="test-against-current-db">Test against current db</h3>
<p>To make a few tests with our filtered db we can call <code>conn.testDbAsOfNow</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">implicit</span> <span class="k">val</span> <span class="n">futConn</span> <span class="k">=</span> <span class="o">...</span>
<span class="k">for</span> <span class="o">{</span>
  <span class="n">conn</span> <span class="k">&lt;-</span> <span class="n">futConn</span>
  
  <span class="c1">// Current state
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">name</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="mi">24</span><span class="o">))</span>
  
  <span class="c1">// Create &#34;branch&#34; of our production db as it is right now
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">testDbAsOfNow</span>  
  
  <span class="c1">// Perform multiple operations on test db
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;Johnny&#34;</span><span class="o">).</span><span class="n">update</span>
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">age</span><span class="o">(</span><span class="mi">25</span><span class="o">).</span><span class="n">update</span>
  
  <span class="c1">// Verify expected outcome of operations
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">name</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="o">(</span><span class="s">&#34;Johnny&#34;</span><span class="o">,</span> <span class="mi">25</span><span class="o">))</span>
  
  <span class="c1">// Then go back to live db
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">useLiveDb</span>
  
  <span class="c1">// Live state is unchanged
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Person</span><span class="o">(</span><span class="n">johnId</span><span class="o">).</span><span class="n">name</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="mi">24</span><span class="o">))</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
</code></pre></div><h3 id="test-db-with-domain-classes">Test db with domain classes</h3>
<p>When molecules are used inside domain classes we want to test the domain operations also without affecting the state of our production database. And also ideally without having to create mockups of our domain objects. This is now possible by setting a temporary test database on the implicit connection object that all molecules expect to be present in their scope - which includes the molecules inside domain classes.</p>
<p>When we test against a temporary filtered database, Molecule internally uses the <code>with</code> function of Datomic to apply transaction data to a filtered database that is simply garbage collected when it goes out of scope.</p>
<p>To make a few tests on a domain object that have molecule calls internally we can now do like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">implicit</span> <span class="k">val</span> <span class="n">futConn</span> <span class="k">=</span> <span class="o">...</span>
<span class="k">for</span> <span class="o">{</span>
  <span class="n">conn</span> <span class="k">&lt;-</span> <span class="n">futConn</span>

  <span class="c1">// Some domain object that we want to test
</span><span class="c1"></span>  <span class="n">domainObj</span> <span class="k">=</span> <span class="nc">MyDomainClass</span><span class="o">(</span><span class="n">params</span><span class="o">..)</span> <span class="c1">// having molecule transactions inside...
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">=</span> <span class="n">domainObj</span><span class="o">.</span><span class="n">myState</span> <span class="o">==&gt;</span> <span class="s">&#34;initial state&#34;</span>

  <span class="c1">// Create &#34;branch&#34; of our production db as it is right now
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">testDbAsOfNow</span>

  <span class="c1">// Test some domain object operations
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">=</span> <span class="n">domainObj</span><span class="o">.</span><span class="n">doThis</span>
  <span class="k">_</span> <span class="k">=</span> <span class="n">domainObj</span><span class="o">.</span><span class="n">doThat</span>

  <span class="c1">// Verify expected outcome of operations
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">=</span> <span class="n">domainObj</span><span class="o">.</span><span class="n">myState</span> <span class="o">==&gt;</span> <span class="s">&#34;some expected changed state&#34;</span>

  <span class="c1">// Then go back to production state
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">useLiveDb</span>

  <span class="c1">// Initial state is unchanged
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">=</span> <span class="n">domainObj</span><span class="o">.</span><span class="n">myState</span> <span class="o">==&gt;</span> <span class="s">&#34;initial state&#34;</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
</code></pre></div><p>Since internal domain methods will in turn call other domain methods that also expects an implicit conn object then the same test db is even propragated recursively inside the chain of domain operations.</p>
<h3 id="multiple-time-views">Multiple time views</h3>
<p>We can apply the above approach with various time views of our database:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">conn</span><span class="o">.</span><span class="n">testDbAsOfNow</span>
<span class="n">conn</span><span class="o">.</span><span class="n">testDbAsOf</span><span class="o">(</span><span class="n">t</span><span class="o">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">testDbSince</span><span class="o">(</span><span class="n">t</span><span class="o">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">testWith</span><span class="o">(</span><span class="n">txData</span><span class="o">)</span>
</code></pre></div><p>This make it possible to run arbitrarily complex test scenarios directly against our production data at any point in time without having to do any manual setup or tear-down of mock domain/database objects!</p>
<h3 id="next">Next</h3>
<p><a href="../../documentation/generic">Generic APIs&hellip;</a></p>

    </div>

    <div class="col-sm-2" style="padding-left:24px;padding-right: 0px;position:sticky;top:115px">
        
<button type="button" id="sidebarCollapse" class="navbar-toggle collapsed" data-toggle="collapse" style="color:#bbb">
  <i class="glyphicon glyphicon-align-left"></i>
</button>

<nav class="bs-docs-sidebar" id="sidebar">
  <ul class="bs-docs-sidenav nav">
    
      

        
        
          
            <li><a href="../../documentation/">Overview</a></li>
          
          
        
          
            <li><a href="../../documentation/attributes/">Attributes</a></li>
          
          
        
          
            <li><a href="../../documentation/relationships/">Relationships</a></li>
          
          
        
          
            <li><a href="../../documentation/transactions/">Transactions</a></li>
          
          
        
          
            <li><a href="../../documentation/transaction-functions/">Transaction Functions</a></li>
          
          
        
          
            <li class="open"><a href="../../documentation/time/"><b>Time</b></a></li>
            
              <nav id="TableOfContents">
  <ul>
    <li></li>
    <li><a href="#point-in-time">Point in time</a></li>
    <li><a href="#asof">AsOf</a></li>
    <li><a href="#since">Since</a></li>
    <li><a href="#history">History</a></li>
    <li><a href="#with">With</a></li>
    <li><a href="#test-against-testdb">Test against TestDb</a></li>
  </ul>
</nav>
            
          
          
        
          
            <li><a href="../../documentation/generic/">Generic APIs</a></li>
          
          
        
          
            <li><a href="../../documentation/dynamic/">Dynamic molecules</a></li>
          
          
        

      
    
  </ul>
</nav>
    </div>

</div> 

     
   
 


</div> 

<footer class="bs-docs-footer">

  <div class="container" style="font-size:15px">
    <ul class="bs-docs-footer-links">
      <li style="margin-top: 8px;"><a href="../../front/"><img src="https://www.scalamolecule.org/img/logo/MoleculeLogo150.png" alt=""></a></li>
      <li><a href="https://github.com/scalamolecule/molecule">GitHub</a></li>
      <li><a href="https://github.com/scalamolecule/molecule-web">GitHub-web</a></li>
      <li><a href="https://gitter.im/scalamolecule/Lobby">Gitter</a></li>
      <li><a href="https://groups.google.com/forum/#!forum/molecule-dsl">Forum</a></li>
      <li><a href="../../about/">About</a></li>
      <li><a href="../../credits/">Credits</a></li>
      <li><a href="../../changelog">Changelog</a></li>
    </ul>
    <p>Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="license">Apache License 2.0</a></p>
  </div>
</footer>


<script type="text/javascript" src="../../js/jquery-1.11.2.min.js"></script>
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>


<script type="text/javascript" src="../../js/scripts.js"></script>
<script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
<script src="../../js/copy-button.js"></script>
<script src="../../js/sidebar-collapser.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2787756-3', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
