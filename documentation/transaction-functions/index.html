<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon"/>
    <title>Transaction Functions</title>
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/css/bootstrap.min.css">
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/css/highlight/styles/solarized_light.css"/>
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/css/syntax-custom.css"/>
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type='text/css' href="https://www.scalamolecule.org/css/style.css">
    <link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic,500,600,700,700italic,800,800italic'>

    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.scalamolecule.org/img/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.scalamolecule.org/img/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.scalamolecule.org/img/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="https://www.scalamolecule.org/img/apple-touch-icon-57-precomposed.png">

    
    
</head>
<body data-spy="scroll" data-target="#sidebar" data-offset="110">
<header class="bs-docs-header">

    <nav class="navbar navbar-inverse">
        <div class="container-fluid" style="max-width:1170px;padding-top:3px">
            
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="../../" style="padding-left: 6px; padding-right: 13px;"><img src="https://www.scalamolecule.org/img/logo/MoleculeLogo150.png"></a>
            </div>

            
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    
                    
                        
                            <li class="dropdown">
                                <a href="../../intro/" target="_top">Intro</a>
                            </li>
                        
                    
                        
                            <li class="dropdown">
                                <a href="../../setup/" target="_top">Setup</a>
                            </li>
                        
                    
                        
                            <li class="active">
                                <a href="../../documentation/" target="_top">Documentation</a>
                                <div></div>
                            </li>
                        
                    
                        
                            <li class="dropdown">
                                <a href="../../dev/" target="_top">Dev</a>
                            </li>
                        
                    
                        
                            <li class="dropdown">
                                <a href="../../community/" target="_top">Community</a>
                            </li>
                        
                    
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="https://javadoc.io/doc/org.scalamolecule/molecule_2.13/latest/index.html" target="_blank" style="">ScalaDocs</a></li>
                    <li><a href="../../changelog" style="">v1.0.3</a></li>
                    <li><a href="https://github.com/scalamolecule/molecule" target="_blank">
                        <img src="https://www.scalamolecule.org/vendor/GitHub-Mark/PNG/GitHub-Mark-Light-32px.png"
                             style="margin-top:-4px;padding-left:15px;opacity:0.6;width:42px;">
                    </a></li>
                </ul>
            </div>
        </div>
    </nav>

</header>

<div class="wrapper">

<div class="container-fluid" style="max-width:1170px">

    <div class="col-sm-10 " style="padding-left:8px;">
        <h1 id="transaction-functions">Transaction functions</h1>
<p>Transaction functions allow to atomically make multiple data operations within one transaction. This feature is available for Datomic Peer systems.</p>
<h3 id="atomic-processing-within-the-transaction">Atomic processing within the transaction</h3>
<p>Transaction functions</p>
<ul>
<li>run on the transactor inside of transactions</li>
<li>can atomically analyze and transform database values</li>
<li>can perform arbitrary logic</li>
<li>must have no side effect</li>
<li>must return transaction data (<code>Future[Seq[Statement]]</code>)</li>
<li>are available for Peers on the jvm platform only</li>
</ul>
<p>Since tx functions have access to the tx database value they are essential to guaranteeing atomicity in updates for instance. You can query the current db value within the transaction logic and thus be sure certain assertions hold before doing some operation.</p>
<h2 id="defining-tx-functions">Defining tx functions</h2>
<p>Molecule facilitates writing tx functions by annotating one or more objects that contain tx function methods:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">molecule.macros.TxFns</span>

<span class="nd">@TxFns</span>
<span class="k">object</span> <span class="nc">myTxFunctions</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">myTxFunction1</span><span class="o">(</span><span class="n">args</span><span class="o">...)</span>
    <span class="o">(</span><span class="k">implicit</span> <span class="n">conn</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Conn</span><span class="o">],</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Statement</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">}</span>
  
  <span class="k">def</span> <span class="n">myTxFunction2</span><span class="o">(</span><span class="n">args</span><span class="o">...)</span>
    <span class="o">(</span><span class="k">implicit</span> <span class="n">conn</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Conn</span><span class="o">],</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Statement</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">}</span>
  <span class="c1">// etc...
</span><span class="c1"></span><span class="o">}</span>

<span class="nd">@TxFns</span>
<span class="k">object</span> <span class="nc">myTxFunctionsSomewhereElse</span> <span class="o">{...}</span>
<span class="c1">// etc...
</span></code></pre></div><p>The macro annotation <code>@TxFns</code> creates an internal &ldquo;twin&rdquo; method at compile time for each Scala tx function that you define. The twin method basically adapts to the way Datomic expects tx functions and automatically gets saved into the Datomic database transparently without any work on your part.</p>
<h4 id="enabling-the-macro-annotation-for-scala-212">Enabling the macro annotation for Scala 2.12</h4>
<p>To use the <code>@TxFns</code> macro annotation with Scala 2.12, you&rsquo;ll need to include the Macro Paradise compiler plugin in your build:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="n">compilerPlugin</span><span class="o">(</span><span class="s">&#34;org.scalamacros&#34;</span> <span class="o">%</span> <span class="s">&#34;paradise&#34;</span> <span class="o">%</span> <span class="s">&#34;2.1.1&#34;</span> <span class="n">cross</span> <span class="nc">CrossVersion</span><span class="o">.</span><span class="n">patch</span><span class="o">)</span>
</code></pre></div><blockquote>
<p>Macro annotations have been considered experimental in Scala and for version 2.12 requires an
import of the scala paradise plugin. In version 2.13 they have been incorporated into the core
language itself and importing the paradise plugin is no longer necessary in 2.13.</p>
</blockquote>
<h3 id="tx-functions-on-the-transactor-classpath">Tx functions on the transactor classpath</h3>
<p>The tx functions also need to be visible to the transactor process meaning that the compiled tx function container must be on the classpath of the transactor. This will depend on the Datomic setup you are using:</p>
<h4 id="local-dev--in-memory">Local dev / in-memory</h4>
<p>No need to prepare anything since transaction functions defined within the project will be available on the classpath for the Transactor managed by the Peer.</p>
<h4 id="starter-pro--pro">Starter pro / pro</h4>
<p>Set Datomic classpath variable to where your tx functions are before starting the transactor</p>
<pre><code>&gt; cd DATOMIC_HOME
&gt; export DATOMIC_EXT_CLASSPATH=/Users/mg/molecule/molecule/coretests/target/scala-2.12/test-classes/
&gt; bin/transactor ...
</code></pre><h4 id="free">Free</h4>
<p>The Free version can&rsquo;t set the classpath variable so we need to provide the tx functions manually by making a jar of our classes, move it to the transactor bin folder and start the transactor:</p>
<pre><code>&gt; cd ~/molecule/molecule/coretests/target/scala-2.12/test-classes  [path to your compiled classes] 
&gt; jar cvf scala-fns.jar .
&gt; mv ~/molecule/molecule/coretests/target/scala-2.12/test-classes/scala-fns.jar DATOMIC_HOME/bin/
&gt; bin/transactor ...
</code></pre><h2 id="tx-function-example">Tx function example</h2>
<p>A typical example of needing access to the tx database value before doing an operation on it could be to transfer money from one account to another.</p>
<h3 id="enforcing-atomic-constraints">Enforcing atomic constraints</h3>
<p>We want to be sure that there is enough available funds before we do the transfer. If we had done the lookup of the current balance outside a transaction we could risk that the balance was updated inbetween our lookup and doing the transfer. With a tx function we can avoid this by having access to the tx database value <em>within the transaction itself</em>. This will give us the necessary atomicity of the whole transfer. The transfer will only happen if there are enough funds available.</p>
<p>Let&rsquo;s look at a simple tx function implementation:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="nd">@TxFns</span>
<span class="k">object</span> <span class="nc">myTxFunctions</span> <span class="o">{</span>

  <span class="c1">// Pass in entity ids of from/to accounts and the amount to be transferred
</span><span class="c1"></span>  <span class="k">def</span> <span class="n">transfer</span><span class="o">(</span><span class="n">from</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
              <span class="o">(</span><span class="k">implicit</span> <span class="n">conn</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Conn</span><span class="o">],</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Statement</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="c1">// Validate sufficient funds in from-account
</span><span class="c1"></span>      <span class="n">curFromBalance</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">(</span><span class="n">from</span><span class="o">).</span><span class="n">int</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">headOption</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>

      <span class="k">_</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">curFromBalance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span>
      <span class="c1">// Throw exception to abort the whole transaction
</span><span class="c1"></span>        <span class="k">throw</span> <span class="nc">TxFnException</span><span class="o">(</span>
          <span class="s">s&#34;Can&#39;t transfer </span><span class="si">$amount</span><span class="s"> from account </span><span class="si">$from</span><span class="s"> having a balance of only </span><span class="si">$curFromBalance</span><span class="s">.&#34;</span>
        <span class="o">)</span>

      <span class="c1">// Calculate new balances
</span><span class="c1"></span>      <span class="n">newFromBalance</span> <span class="k">=</span> <span class="n">curFromBalance</span> <span class="o">-</span> <span class="n">amount</span>
      <span class="n">newToBalance</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">(</span><span class="n">to</span><span class="o">).</span><span class="n">int</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">headOption</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">amount</span><span class="o">)</span>

      <span class="c1">// Update accounts
</span><span class="c1"></span>      <span class="n">newFromStmts</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">(</span><span class="n">from</span><span class="o">).</span><span class="n">int</span><span class="o">(</span><span class="n">newFromBalance</span><span class="o">).</span><span class="n">getUpdateStmts</span>
      <span class="n">newToStmts</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">(</span><span class="n">to</span><span class="o">).</span><span class="n">int</span><span class="o">(</span><span class="n">newToBalance</span><span class="o">).</span><span class="n">getUpdateStmts</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">newFromStmts</span> <span class="o">++</span> <span class="n">newToStmts</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>The signature of a tx functions must include implicit <code>Conn</code> and <code>ExecutionContext</code> parameters. This makes sure that the macro annotation can inject a database value in the generated transparent twin function for Datomic.</p>
<p>We first check the available-funds constraint by looking up the current balance and throw an exception if there is not enough money available. Throwing an exception inside a tx function will cancel the whole transaction and thereby guarantee atomicity.</p>
<p>Tx functions need to return transaction statements. We use Molecule&rsquo;s tx methods on molecules for the equivalent operations to get the necessary statements. So, to get the transaction statements of an update we simply replace a normal <code>update</code> call too <code>getUpdateStmts</code> which will give us the transaction statements produced:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// Isolated update transaction (not in tx function)
</span><span class="c1"></span><span class="nc">Account</span><span class="o">(</span><span class="n">from</span><span class="o">).</span><span class="n">balance</span><span class="o">(</span><span class="n">newFromBalance</span><span class="o">).</span><span class="n">update</span>

<span class="c1">// .. equivalent to the transaction statements returned by `getUpdateStmts` 
</span><span class="c1"></span><span class="nc">Account</span><span class="o">(</span><span class="n">from</span><span class="o">).</span><span class="n">balance</span><span class="o">(</span><span class="n">newFromBalance</span><span class="o">).</span><span class="n">getUpdateStmts</span>
</code></pre></div><h3 id="tx-functions-have-to-be-pure">Tx functions have to be pure</h3>
<p>Tx functions can&rsquo;t modify the database within the body of the tx method. You couldn&rsquo;t for instance do an update within the method body. Any operations on the database have to be encoded in the returned transaction statements.</p>
<h2 id="invoking-tx-functions">Invoking tx functions</h2>
<p>We call the transaction function inside a <code>transactFn</code> method:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">transactFn</span><span class="o">(</span><span class="n">transfer</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">,</span> <span class="n">toAccount</span><span class="o">,</span> <span class="n">okAmount</span><span class="o">))</span>
</code></pre></div><p><code>transactFn</code> is a macro that needs the tx function invocation itself as its argument in order to be able to analyze the tx function at compile time.</p>
<p>So our complete example could look like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// Initial balances
</span><span class="c1"></span><span class="nc">Account</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">).</span><span class="n">balance</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">100</span><span class="o">)</span>
<span class="nc">Account</span><span class="o">(</span><span class="n">toAccount</span><span class="o">).</span><span class="n">balance</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">700</span><span class="o">)</span>

<span class="c1">// Invoke tx function to do the transfer and pass the produced tx statements to `transactFn`
</span><span class="c1"></span><span class="n">transactFn</span><span class="o">(</span><span class="n">transfer</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">,</span> <span class="n">toAccount</span><span class="o">,</span> <span class="mi">20</span><span class="o">))</span>

<span class="c1">// Balances after transfer
</span><span class="c1"></span><span class="nc">Account</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">).</span><span class="n">balance</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">80</span><span class="o">)</span>
<span class="nc">Account</span><span class="o">(</span><span class="n">toAccount</span><span class="o">).</span><span class="n">balance</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">720</span><span class="o">)</span>
</code></pre></div><h3 id="error-handling---ensuring-atomicity">Error handling - ensuring atomicity</h3>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">for</span> <span class="o">{</span>
  <span class="n">fromAccount</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">.</span><span class="n">int</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">save</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">eid</span><span class="o">)</span>
  <span class="n">toAccount</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">.</span><span class="n">int</span><span class="o">(</span><span class="mi">700</span><span class="o">).</span><span class="n">save</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">eid</span><span class="o">)</span>
  <span class="n">tooBigAmount</span> <span class="k">=</span> <span class="mi">200</span>
  
  <span class="c1">// Trying to transfer a too big amount will return a failed Future with an exception 
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">transactFn</span><span class="o">(</span><span class="n">transfer</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">,</span> <span class="n">toAccount</span><span class="o">,</span> <span class="n">tooBigAmount</span><span class="o">))</span>
    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">==&gt;</span> <span class="s">&#34;Unexpected success&#34;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">recover</span> <span class="o">{</span> <span class="k">case</span> <span class="nc">TxFnException</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">msg</span> <span class="o">==&gt;</span> <span class="s">s&#34;Can&#39;t transfer 200 from account </span><span class="si">$fromAccount</span><span class="s"> having a balance of only 100.&#34;</span>
    <span class="o">}</span>
  
  <span class="c1">// No data has been changed
</span><span class="c1"></span>  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Account</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">).</span><span class="n">balance</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">100</span><span class="o">)</span>
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Account</span><span class="o">(</span><span class="n">toAccount</span><span class="o">).</span><span class="n">balance</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">700</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
</code></pre></div><h3 id="composing-tx-functions">Composing tx functions</h3>
<p>A tx function can be called from another tx function. We can thus compose more complex tx functions from &ldquo;sub tx functions&rdquo;. We could for instance de-compose our previous transfer tx function into two sub tx functions <code>withdraw</code> and <code>deposit</code> and then call those from a <code>transferComposed</code> tx function:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// &#34;Sub&#34; tx fn - can be used on its own or in other tx functions
</span><span class="c1"></span><span class="k">def</span> <span class="n">withdraw</span><span class="o">(</span><span class="n">from</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
            <span class="o">(</span><span class="k">implicit</span> <span class="n">conn</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Conn</span><span class="o">],</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Statement</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">curFromBalance</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">(</span><span class="n">from</span><span class="o">).</span><span class="n">int</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">headOption</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>

    <span class="k">_</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">curFromBalance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span>
      <span class="k">throw</span> <span class="nc">TxFnException</span><span class="o">(</span>
        <span class="s">s&#34;Can&#39;t transfer </span><span class="si">$amount</span><span class="s"> from account </span><span class="si">$from</span><span class="s"> having a balance of only </span><span class="si">$curFromBalance</span><span class="s">.&#34;</span><span class="o">)</span>

    <span class="n">newFromBalance</span> <span class="k">=</span> <span class="n">curFromBalance</span> <span class="o">-</span> <span class="n">amount</span>
    <span class="n">stmts</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">(</span><span class="n">from</span><span class="o">).</span><span class="n">int</span><span class="o">(</span><span class="n">newFromBalance</span><span class="o">).</span><span class="n">getUpdateStmts</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">stmts</span>
<span class="o">}</span>

<span class="c1">// &#34;Sub&#34; tx fn - can be used on its own or in other tx functions
</span><span class="c1"></span><span class="k">def</span> <span class="n">deposit</span><span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
           <span class="o">(</span><span class="k">implicit</span> <span class="n">conn</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Conn</span><span class="o">],</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Statement</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">newToBalance</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">(</span><span class="n">to</span><span class="o">).</span><span class="n">int</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">headOption</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">amount</span><span class="o">)</span>
    <span class="n">stmts</span> <span class="k">&lt;-</span> <span class="nc">Ns</span><span class="o">(</span><span class="n">to</span><span class="o">).</span><span class="n">int</span><span class="o">(</span><span class="n">newToBalance</span><span class="o">).</span><span class="n">getUpdateStmts</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">stmts</span>
<span class="o">}</span>

<span class="c1">// Compose tx function by calling other tx functions
</span><span class="c1"></span><span class="k">def</span> <span class="n">transferComposed</span><span class="o">(</span><span class="n">from</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">amount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
                    <span class="o">(</span><span class="k">implicit</span> <span class="n">conn</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Conn</span><span class="o">],</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Statement</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="c1">// This tx function guarantees atomicity when calling multiple sub tx functions.
</span><span class="c1"></span>    <span class="c1">// If they were called independently outside a tx function, atomicity wouldn&#39;t be guaranteed.
</span><span class="c1"></span>    <span class="n">withdrawStmts</span> <span class="k">&lt;-</span> <span class="n">withdraw</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">amount</span><span class="o">)</span>
    <span class="n">depositStmts</span> <span class="k">&lt;-</span> <span class="n">deposit</span><span class="o">(</span><span class="n">to</span><span class="o">,</span> <span class="n">amount</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">withdrawStmts</span> <span class="o">++</span> <span class="n">depositStmts</span>
<span class="o">}</span>
</code></pre></div><h3 id="adding-tx-meta-data-to-tx-function-invocations">Adding tx meta data to tx function invocations</h3>
<p>Tx meta data can be added to a tx function invocation by adding one or more tx meta data molecules with applied tx meta data to the <code>transactFn</code>/<code>transactFnAsync</code> method. Say we want to add meta information about &ldquo;who did the transfer&rdquo; then we can add it to the transaction entity like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// Add tx meta data that John did the transfer
</span><span class="c1"></span><span class="n">transactFn</span><span class="o">(</span><span class="n">transfer</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">,</span> <span class="n">toAccount</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">))</span>

<span class="c1">// We can then query for the transfer that John did
</span><span class="c1"></span><span class="nc">Account</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">).</span><span class="n">balance</span><span class="o">.</span><span class="nc">Tx</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="n">name_</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">)).</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">80</span><span class="o">)</span>
<span class="nc">Account</span><span class="o">(</span><span class="n">toAccount</span><span class="o">).</span><span class="n">balance</span><span class="o">.</span><span class="nc">Tx</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="n">name_</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">)).</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">720</span><span class="o">)</span>
</code></pre></div><p>Note how the tx meta data applies to both accounts since they were both modified in the same transaction that the tx meta data was applied to.</p>
<p>We can add arbitrary and possibly unrelated tx meta data to a tx function invocation by applying two or more tx meta data molecules:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// Add tx meta data that John did the transfer and that it is a scheduled transfer
</span><span class="c1"></span><span class="n">transactFn</span><span class="o">(</span>
  <span class="n">transfer</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">,</span> <span class="n">toAccount</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> 
  <span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">),</span> 
  <span class="nc">UseCase</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;Scheduled transfer&#34;</span><span class="o">)</span>
<span class="o">)</span>

<span class="c1">// Query multiple Tx meta data molecules
</span><span class="c1"></span><span class="nc">Account</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">).</span><span class="n">balance</span>
  <span class="o">.</span><span class="nc">Tx</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="n">name_</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">))</span>
  <span class="o">.</span><span class="nc">Tx</span><span class="o">(</span><span class="nc">UseCase</span><span class="o">.</span><span class="n">name_</span><span class="o">(</span><span class="s">&#34;Scheduled transfer&#34;</span><span class="o">)).</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">80</span><span class="o">)</span>

<span class="nc">Account</span><span class="o">(</span><span class="n">toAccount</span><span class="o">).</span><span class="n">balance</span>
  <span class="o">.</span><span class="nc">Tx</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="n">name_</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">))</span>
  <span class="o">.</span><span class="nc">Tx</span><span class="o">(</span><span class="nc">UseCase</span><span class="o">.</span><span class="n">name_</span><span class="o">(</span><span class="s">&#34;Scheduled transfer&#34;</span><span class="o">)).</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">head</span> <span class="o">==&gt;</span> <span class="mi">720</span><span class="o">)</span>
</code></pre></div><h2 id="inspecting-invocations">Inspecting invocations</h2>
<p>If you want to see the <code>Statement</code>s produced by a tx function you can invoke it within <code>inspectTransactFn</code> without affecting the live database:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// Print inspect info for tx function invocation
</span><span class="c1"></span><span class="n">inspectTransactFn</span><span class="o">(</span><span class="n">transfer</span><span class="o">(</span><span class="n">fromAccount</span><span class="o">,</span> <span class="n">toAccount</span><span class="o">,</span> <span class="mi">20</span><span class="o">))</span>

<span class="c1">// Prints produced tx statements to output:
</span><span class="c1"></span><span class="cm">/*
</span><span class="cm">## 1 ## TxReport 
</span><span class="cm">========================================================================
</span><span class="cm">ArrayBuffer(
</span><span class="cm">  List(
</span><span class="cm">    :db/add       17592186045445       :Account/balance    80        Card(1))
</span><span class="cm">  List(
</span><span class="cm">    :db/add       17592186045447       :Account/balance    720       Card(1)))
</span><span class="cm">------------------------------------------------
</span><span class="cm">List(
</span><span class="cm">  added: true ,   t: 13194139534345,   e: 13194139534345,   a: 50,   v: Thu Nov 22 16:23:09 CET 2018
</span><span class="cm">
</span><span class="cm">  added: true ,   t: 13194139534345,   e: 17592186045445,   a: 64,   v: 80
</span><span class="cm">  added: false,  -t: 13194139534345,  -e: 17592186045445,  -a: 64,  -v: 100
</span><span class="cm">
</span><span class="cm">  added: true ,   t: 13194139534345,   e: 17592186045447,   a: 64,   v: 720
</span><span class="cm">  added: false,  -t: 13194139534345,  -e: 17592186045447,  -a: 64,  -v: 700)
</span><span class="cm">========================================================================
</span><span class="cm">*/</span>
</code></pre></div><p>Two groups of data are shown. The first group is an internal representation in Molecule showing the operations. The second group shows the datoms produced in the transaction. For ease of reading, &ldquo;-&rdquo; (minus) is prepended the prefixes (t, e, a, v) for the datoms that are retractions - where <code>added</code> is false. The abbreviations represents the parts of the Datom:</p>
<ul>
<li><code>added</code>: operation, can be true for asserted or false for retracted</li>
<li><code>t</code>: transaction entity id</li>
<li><code>e</code>: entity</li>
<li><code>a</code>: attribute</li>
<li><code>v</code>: value</li>
</ul>
<p>Updating the from-account balance from 100 to 80 for instance creates two Datoms, one retracting the old value 100 and one asserting the new value 80.</p>
<h3 id="next">Next</h3>
<p><a href="../../documentation/time">Time&hellip;</a></p>

    </div>

    <div class="col-sm-2" style="padding-left:24px;padding-right: 0px;position:sticky;top:115px">
        
<button type="button" id="sidebarCollapse" class="navbar-toggle collapsed" data-toggle="collapse" style="color:#bbb">
  <i class="glyphicon glyphicon-align-left"></i>
</button>

<nav class="bs-docs-sidebar" id="sidebar">
  <ul class="bs-docs-sidenav nav">
    
      

        
        
          
            <li><a href="../../documentation/">Overview</a></li>
          
          
        
          
            <li><a href="../../documentation/attributes/">Attributes</a></li>
          
          
        
          
            <li><a href="../../documentation/relationships/">Relationships</a></li>
          
          
        
          
            <li><a href="../../documentation/transactions/">Transactions</a></li>
          
          
        
          
            <li class="open"><a href="../../documentation/transaction-functions/"><b>Transaction Functions</b></a></li>
            
              <nav id="TableOfContents">
  <ul>
    <li></li>
    <li><a href="#defining-tx-functions">Defining tx functions</a></li>
    <li><a href="#tx-function-example">Tx function example</a></li>
    <li><a href="#invoking-tx-functions">Invoking tx functions</a></li>
    <li><a href="#inspecting-invocations">Inspecting invocations</a></li>
  </ul>
</nav>
            
          
          
        
          
            <li><a href="../../documentation/time/">Time</a></li>
          
          
        
          
            <li><a href="../../documentation/generic/">Generic APIs</a></li>
          
          
        
          
            <li><a href="../../documentation/dynamic/">Dynamic molecules</a></li>
          
          
        

      
    
  </ul>
</nav>
    </div>

</div> 

     
   
 


</div> 

<footer class="bs-docs-footer">

  <div class="container" style="font-size:15px">
    <ul class="bs-docs-footer-links">
      <li style="margin-top: 8px;"><a href="../../front/"><img src="https://www.scalamolecule.org/img/logo/MoleculeLogo150.png" alt=""></a></li>
      <li><a href="https://github.com/scalamolecule/molecule">GitHub</a></li>
      <li><a href="https://github.com/scalamolecule/molecule-web">GitHub-web</a></li>
      <li><a href="https://gitter.im/scalamolecule/Lobby">Gitter</a></li>
      <li><a href="https://groups.google.com/forum/#!forum/molecule-dsl">Forum</a></li>
      <li><a href="../../about/">About</a></li>
      <li><a href="../../credits/">Credits</a></li>
      <li><a href="../../changelog">Changelog</a></li>
    </ul>
    <p>Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="license">Apache License 2.0</a></p>
  </div>
</footer>


<script type="text/javascript" src="../../js/jquery-1.11.2.min.js"></script>
<script type="text/javascript" src="../../js/bootstrap.min.js"></script>


<script type="text/javascript" src="../../js/scripts.js"></script>
<script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
<script src="../../js/copy-button.js"></script>
<script src="../../js/sidebar-collapser.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2787756-3', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
